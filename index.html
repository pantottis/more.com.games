<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>more.com Game Suite</title>
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Game Suite">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎮</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            user-select: none;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            min-height: 600px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .game-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .game-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .game-card:hover {
            transform: scale(1.05);
        }

        .quiz-question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
        }

        .quiz-option {
            background: white;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .quiz-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .puzzle-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            margin: 20px auto;
            width: 400px;
            height: 400px;
        }

        .puzzle-tile {
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            transition: all 0.2s;
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            min-height: 95px;
            min-width: 95px;
        }

        .puzzle-tile:hover {
            transform: scale(1.02);
            border-color: #667eea;
        }

        .puzzle-tile.empty {
            background: rgba(255,255,255,0.1) !important;
            border: 2px dashed #ccc;
        }

        .basketball-game {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(to bottom, #87CEEB, #98FB98);
            border-radius: 10px;
            overflow: hidden;
        }

        .basket {
            position: absolute;
            top: 100px;
            right: 50px;
            width: 80px;
            height: 40px;
            background: #8B4513;
            border-radius: 0 0 40px 40px;
            border: 3px solid #654321;
        }

        .ball {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #FF8C00;
            border-radius: 50%;
            bottom: 50px;
            left: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 2px solid #FF6347;
        }

        .stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .timer {
            font-size: 24px;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .back-button {
            background: #6c757d;
            margin-bottom: 20px;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .error-display {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .result-content {
            text-align: center;
            padding: 40px 20px;
        }

        .result-win {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }

        .result-lose {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3);
        }

        .result-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .result-message {
            font-size: 1.5em;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .result-stats {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.2em;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }

        .result-emoji {
            font-size: 4em;
            margin-bottom: 20px;
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .game-selection {
                grid-template-columns: 1fr;
            }
            
            .puzzle-container {
                width: 300px;
                height: 300px;
            }
        }
    </style>
    
</head>
<body>
    <div class="container">
        <button id="downloadEmailsBtn" style="display:none; font-size:12px; padding:4px 12px; border-radius:6px; margin:10px 0;">
            Download Emails
        </button>

        <!-- Registration Screen -->
        <div id="registration" class="screen active">
            <h1>🎮 Welcome to a more FIBA Game Suite</h1>
            <div class="error-display" id="registrationError"></div>
            <div id="registrationForm">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required>
                </div>
                <button type="button" onclick="registerPlayer()" id="registerBtn">Start Playing!</button>
                <div class="loading" id="loadingMessage" style="display: none;">Registering player...</div>
            </div>
        </div>

        <!-- Game Selection Screen -->
        <div id="gameSelection" class="screen">
            <h1>Choose Your Game</h1>
            <p style="text-align: center; margin-bottom: 20px;">Welcome, <span id="playerName"></span>!</p>
            <div class="game-selection">
                <div class="game-card" onclick="startQuiz()">
                    <h3>🧠 Quiz Challenge</h3>
                    <p>Answer 5 questions correctly</p>
                </div>
                <div class="game-card" onclick="startPuzzleGame()">
                    <h3>🧩 FIBA Puzzle Master</h3>
                    <p>Solve the sliding puzzle in time</p>
                </div>
                <div class="game-card" onclick="startBasketball()">
                    <h3>🏀 More Hoops</h3>
                    <p>Score hoops within the time limit</p>
                </div>
            </div>
        </div>

        <!-- Quiz Game Screen -->
        <div id="quizGame" class="screen">
            <button class="back-button" onclick="backToSelection()">← Back</button>
            <h2>Quiz Challenge</h2>
            <div class="timer" id="quizTimer">Question 1 of 5</div>
            <div id="quizContent"></div>
            <button id="nextQuestion" onclick="nextQuestion()" style="display: none;">Next Question</button>
            <button id="finishQuiz" onclick="finishQuiz()" style="display: none;">Finish Quiz</button>
        </div>

        <!-- Puzzle Game Screen -->
        <div id="puzzleGame" class="screen">
            <button class="back-button" onclick="backToSelection()">← Back</button>
            <h2>Sliding Puzzle</h2>
            <div class="timer" id="puzzleTimer">Time: 60s</div>
            <div class="puzzle-container" id="puzzleContainer"></div>
            <button onclick="resetPuzzle()">Reset</button>
        </div>

        <!-- Basketball Game Screen -->
        <div id="basketballGame" class="screen">
            <button class="back-button" onclick="backToSelection()">← Back</button>
            <h2>Basketball Hoops</h2>
            <div class="basketball-game">
                <div class="stats">
                    <div>Score: <span id="basketballScore">0</span>/10</div>
                    <div>Time: <span id="basketballTimer">30</span>s</div>
                </div>
                <div class="basket"></div>
                <div class="ball" id="basketballBall"></div>
            </div>
            <p style="text-align: center; margin-top: 10px;">Click and drag the ball towards the basket!</p>
        </div>

        <!-- Game Results Screen -->
        <div id="gameResults" class="screen">
            <div id="resultContent" class="result-content">
                <!-- Results will be dynamically inserted here -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="backToSelection()">Play Another Game</button>
                <button onclick="showScreen('registration')" style="background: #6c757d;">New Player</button>
            </div>
        </div>
    </div>
    <script src="quiz-config.js"></script>
    <script>
        // Game Configuration
        const QUIZ_CONFIG = window.QUIZ_CONFIG;

        // Game State Variables
        let currentPlayer = null;
        let currentQuizQuestion = 0;
        let quizScore = 0;
        let selectedAnswer = null;
        let puzzleTimer = null;
        let basketballTimer = null;
        let basketballScore = 0;
        let puzzleSize = 3;
        let puzzleGrid = [];
        let puzzleTimeLeft = 60;
        let puzzleTileImages = [];
        let isDragging = false;
        let startX, startY;

        // In-memory storage for player data
        let gamePlayersDB = [];

        // Utility Functions
        function showError(message) {
            const errorDiv = document.getElementById('registrationError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 4000);
            }
            console.log('Error:', message);
        }

        function showLoading(show = true) {
            const loadingDiv = document.getElementById('loadingMessage');
            const button = document.getElementById('registerBtn');
            if (loadingDiv && button) {
                loadingDiv.style.display = show ? 'block' : 'none';
                button.disabled = show;
                button.style.opacity = show ? '0.5' : '1';
            }
        }

        // Data Management Functions
        function savePlayerData(name, email) {
            const playerData = {
                id: Date.now(),
                name: name,
                email: email,
                timestamp: new Date().toISOString(),
                games: []
            };
            
            gamePlayersDB.push(playerData);
            console.log('Player saved:', playerData);
            return playerData;
        }

        function updatePlayerGameResult(playerId, gameType, result) {
            const playerIndex = gamePlayersDB.findIndex(p => p.id === playerId);
            if (playerIndex !== -1) {
                gamePlayersDB[playerIndex].games.push({
                    type: gameType,
                    result: result,
                    timestamp: new Date().toISOString()
                });
                console.log('Updated player database:', gamePlayersDB);
            }
        }

        // Registration Function
        function registerPlayer() {
            console.log('Registration started');
            
            const errorDiv = document.getElementById('registrationError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            
            showLoading(true);
            
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            
            if (!nameInput || !emailInput) {
                console.error('Form inputs not found');
                showLoading(false);
                showError('Form elements not found. Please refresh and try again.');
                return;
            }
            
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            
            console.log('Name:', name, 'Email:', email);
            
            if (!name) {
                showLoading(false);
                showError('Please enter your name.');
                nameInput.focus();
                return;
            }
            
            if (!email) {
                showLoading(false);
                showError('Please enter your email.');
                emailInput.focus();
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                showLoading(false);
                showError('Please enter a valid email address.');
                emailInput.focus();
                return;
            }
            
            setTimeout(() => {
                try {
                    console.log('Saving player data...');
                    currentPlayer = savePlayerData(name, email);
                    console.log('Player created:', currentPlayer);
                    
                    const playerNameElement = document.getElementById('playerName');
                    if (playerNameElement) {
                        playerNameElement.textContent = name;
                        console.log('Player name set in game selection');
                    }
                    
                    console.log('Switching to game selection...');
                    showLoading(false);
                    showScreen('gameSelection');
                    
                } catch (error) {
                    console.error('Error in registration process:', error);
                    showLoading(false);
                    showError('Registration failed. Please try again.');
                }
            }, 500);
        }

        // Screen Navigation
        function showScreen(screenId) {
            console.log('Switching to screen:', screenId);
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                return true;
            } else {
                console.error('Screen not found:', screenId);
                return false;
            }
        }

        function backToSelection() {
            showScreen('gameSelection');
            if (puzzleTimer) clearInterval(puzzleTimer);
            if (basketballTimer) clearInterval(basketballTimer);
        }

        // Game Results System
        function showGameResult(gameType, won, stats = {}) {
            const resultContent = document.getElementById('resultContent');
            if (!resultContent) return;

            const winMessage = "Congrats on winning a More.com Present";
            const loseMessage = "Well.. that was unlucky wasn't it?";
            
            const resultClass = won ? 'result-win' : 'result-lose';
            const emoji = won ? '🎉' : '😅';
            const title = won ? 'WINNER!' : 'GAME OVER';
            const message = won ? winMessage : loseMessage;

            let statsHtml = '';
            if (Object.keys(stats).length > 0) {
                statsHtml = '<div class="result-stats">';
                for (const [key, value] of Object.entries(stats)) {
                    statsHtml += `<div><strong>${key}:</strong> ${value}</div>`;
                }
                statsHtml += '</div>';
            }

            resultContent.innerHTML = `
                <div class="${resultClass}">
                    <span class="result-emoji">${emoji}</span>
                    <div class="result-title">${title}</div>
                    <div class="result-message">${message}</div>
                    ${statsHtml}
                </div>
            `;

            showScreen('gameResults');
            
            if (currentPlayer) {
                updatePlayerGameResult(currentPlayer.id, gameType, {
                    won: won,
                    stats: stats,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // Quiz Game Functions
        function startQuiz() {
            currentQuizQuestion = 0;
            quizScore = 0;
            showScreen('quizGame');
            displayQuestion();
        }

        function displayQuestion() {
            const question = QUIZ_CONFIG.questions[currentQuizQuestion];
            selectedAnswer = null;
            
            document.getElementById('quizTimer').textContent = `Question ${currentQuizQuestion + 1} of ${QUIZ_CONFIG.questions.length}`;
            
            const content = document.getElementById('quizContent');
            content.innerHTML = `
                <div class="quiz-question">
                    <h3>${question.question}</h3>
                    <div class="quiz-options">
                        ${question.options.map((option, index) => 
                            `<div class="quiz-option" onclick="selectAnswer(${index})">${option}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('nextQuestion').style.display = 'none';
            document.getElementById('finishQuiz').style.display = 'none';
        }

        function selectAnswer(answerIndex) {
            selectedAnswer = answerIndex;
            document.querySelectorAll('.quiz-option').forEach((option, index) => {
                option.classList.remove('selected');
                if (index === answerIndex) {
                    option.classList.add('selected');
                }
            });
            
            if (currentQuizQuestion < QUIZ_CONFIG.questions.length - 1) {
                document.getElementById('nextQuestion').style.display = 'inline-block';
            } else {
                document.getElementById('finishQuiz').style.display = 'inline-block';
            }
        }

        function nextQuestion() {
            if (selectedAnswer !== null) {
                if (selectedAnswer === QUIZ_CONFIG.questions[currentQuizQuestion].correct) {
                    quizScore++;
                }
                currentQuizQuestion++;
                displayQuestion();
            }
        }

        function finishQuiz() {
            if (selectedAnswer !== null) {
                if (selectedAnswer === QUIZ_CONFIG.questions[currentQuizQuestion].correct) {
                    quizScore++;
                }
                
                const passed = quizScore == 5;
                const stats = {
                    'Score': `${quizScore}/${QUIZ_CONFIG.questions.length}`,
                    'Percentage': `${Math.round((quizScore / QUIZ_CONFIG.questions.length) * 100)}%`
                };
                
                showGameResult('quiz', passed, stats);
            }
        }

        // Puzzle Game with Basketball Player Images
        async function loadPuzzleTileImages() {
            console.log('🏀 Loading basketball player puzzle tiles...');
            puzzleTileImages = [];
            
            try {
                // Updated to match your file structure
                const imageFiles = Array.from({length: 8}, (_, i) => `images/${i + 1}.jpg`);
                
                const loadPromises = imageFiles.map((filename, index) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => {
                            console.log(`✅ Loaded tile ${index + 1}/8: ${filename}`);
                            resolve(filename);
                        };
                        img.onerror = () => {
                            console.error(`❌ Failed to load ${filename}`);
                            resolve(createFallbackTile(index + 1));
                        };
                        img.src = filename;
                    });
                });
                
                puzzleTileImages = await Promise.all(loadPromises);
                console.log('✅ All puzzle tiles processed:', puzzleTileImages.length);
                return true;
                
            } catch (error) {
                console.error('❌ Error loading puzzle tiles:', error);
                createFallbackTiles();
                return false;
            }
        }

        function createFallbackTile(tileNumber) {
            const svg = `
                <svg width="95" height="95" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad${tileNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FF8C00"/>
                            <stop offset="100%" style="stop-color:#FF6347"/>
                        </linearGradient>
                    </defs>
                    <rect width="95" height="95" fill="url(#grad${tileNumber})" rx="4"/>
                    <circle cx="47.5" cy="47.5" r="35" fill="none" stroke="white" stroke-width="2"/>
                    <text x="47.5" y="52" text-anchor="middle" fill="white" font-size="16" font-weight="bold">${tileNumber}</text>
                </svg>
            `;
            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        }

        function createFallbackTiles() {
            console.log('Creating fallback tiles...');
            puzzleTileImages = [];
            for (let i = 1; i <= 8; i++) {
                puzzleTileImages.push(createFallbackTile(i));
            }
        }

        function startPuzzleGame() {
            console.log('🧩 Starting basketball player puzzle game...');
            showScreen('puzzleGame');
            
            loadPuzzleTileImages().then((success) => {
                if (success || puzzleTileImages.length === 8) {
                    console.log('✅ Initializing puzzle with basketball player tiles');
                    initializePuzzle();
                    startPuzzleTimer();
                } else {
                    console.error('❌ Failed to load tiles, using fallbacks');
                    createFallbackTiles();
                    initializePuzzle();
                    startPuzzleTimer();
                }
            });
        }

        function initializePuzzle() {
            puzzleGrid = [];
            for (let i = 1; i <= 8; i++) {
                puzzleGrid.push(i);
            }
            puzzleGrid.push(null);
            
            const container = document.getElementById('puzzleContainer');
            if (!container) {
                console.error('Puzzle container not found!');
                return;
            }
            
            renderPuzzle();
            console.log('Showing solved basketball player puzzle');
            
            setTimeout(() => {
                console.log('Auto-shuffling puzzle...');
                shufflePuzzle();
                renderPuzzle();
                console.log('Basketball player puzzle shuffled and ready to play!');
            }, 3000);
        }

        function renderPuzzle() {
            const container = document.getElementById('puzzleContainer');
            if (!container) {
                console.error('Container not found for rendering');
                return;
            }
            
            container.innerHTML = '';
            
            puzzleGrid.forEach((tileNumber, position) => {
                const tileElement = document.createElement('div');
                tileElement.className = 'puzzle-tile';
                
                if (tileNumber === null) {
                    tileElement.classList.add('empty');
                    tileElement.style.background = 'rgba(255,255,255,0.3)';
                    tileElement.style.border = '2px dashed #ccc';
                } else {
                    const imageIndex = tileNumber - 1;
                    if (puzzleTileImages[imageIndex]) {
                        tileElement.style.backgroundImage = `url("${puzzleTileImages[imageIndex]}")`;
                        console.log(`Tile ${tileNumber} using image ${imageIndex + 1}`);
                    } else {
                        tileElement.style.background = 'linear-gradient(45deg, #FF8C00, #FF6347)';
                        tileElement.style.color = 'white';
                        tileElement.textContent = tileNumber;
                    }
                    
                    tileElement.addEventListener('click', () => moveTile(position));
                }
                
                container.appendChild(tileElement);
            });
            
            console.log('✅ Puzzle rendered with basketball player images');
        }

        function moveTile(clickedPosition) {
            const emptyPosition = puzzleGrid.indexOf(null);
            const clickedRow = Math.floor(clickedPosition / puzzleSize);
            const clickedCol = clickedPosition % puzzleSize;
            const emptyRow = Math.floor(emptyPosition / puzzleSize);
            const emptyCol = emptyPosition % puzzleSize;
            
            const isAdjacent = (Math.abs(clickedRow - emptyRow) === 1 && clickedCol === emptyCol) || 
                              (Math.abs(clickedCol - emptyCol) === 1 && clickedRow === emptyRow);
            
            if (isAdjacent) {
                [puzzleGrid[clickedPosition], puzzleGrid[emptyPosition]] = [puzzleGrid[emptyPosition], puzzleGrid[clickedPosition]];
                
                renderPuzzle();
                
                if (isPuzzleSolved()) {
                    clearInterval(puzzleTimer);
                    const timeUsed = 60 - puzzleTimeLeft;
                    const stats = {
                        'Time Used': `${timeUsed} seconds`,
                        'Time Remaining': `${puzzleTimeLeft} seconds`
                    };
                    
                    showGameResult('puzzle', true, stats);
                }
            }
        }

        function isPuzzleSolved() {
            for (let i = 0; i < puzzleGrid.length - 1; i++) {
                if (puzzleGrid[i] !== i + 1) return false;
            }
            return puzzleGrid[puzzleGrid.length - 1] === null;
        }

        function shufflePuzzle() {
            for (let i = 0; i < 1000; i++) {
                const emptyPosition = puzzleGrid.indexOf(null);
                const adjacentPositions = getAdjacentPositions(emptyPosition);
                const randomPosition = adjacentPositions[Math.floor(Math.random() * adjacentPositions.length)];
                
                [puzzleGrid[emptyPosition], puzzleGrid[randomPosition]] = [puzzleGrid[randomPosition], puzzleGrid[emptyPosition]];
            }
        }

        function getAdjacentPositions(position) {
            const row = Math.floor(position / puzzleSize);
            const col = position % puzzleSize;
            const adjacent = [];
            
            if (row > 0) adjacent.push((row - 1) * puzzleSize + col);
            if (row < puzzleSize - 1) adjacent.push((row + 1) * puzzleSize + col);
            if (col > 0) adjacent.push(row * puzzleSize + (col - 1));
            if (col < puzzleSize - 1) adjacent.push(row * puzzleSize + (col + 1));
            
            return adjacent;
        }

        function startPuzzleTimer() {
            puzzleTimeLeft = 90;
            puzzleTimer = setInterval(() => {
                puzzleTimeLeft--;
                document.getElementById('puzzleTimer').textContent = `Time: ${puzzleTimeLeft}s`;
                
                if (puzzleTimeLeft <= 0) {
                    clearInterval(puzzleTimer);
                    const stats = {
                        'Result': 'Time expired',
                        'Time Limit': '90 seconds'
                    };
                    
                    showGameResult('puzzle', false, stats);
                }
            }, 1000);
        }

        function resetPuzzle() {
            initializePuzzle();
            puzzleTimeLeft = 60;
            document.getElementById('puzzleTimer').textContent = `Time: ${puzzleTimeLeft}s`;
        }

        // Basketball Game Functions
        function startBasketball() {
            showScreen('basketballGame');
            basketballScore = 0;
            document.getElementById('basketballScore').textContent = basketballScore;
            resetBall();
            startBasketballTimer();
        }

        function startBasketballTimer() {
            let timeLeft = 30;
            document.getElementById('basketballTimer').textContent = timeLeft;
            
            basketballTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('basketballTimer').textContent = timeLeft;
                
                if (timeLeft <= 0 || basketballScore >= 10) {
                    clearInterval(basketballTimer);
                    
                    const won = basketballScore >= 10;
                    const stats = {
                        'Final Score': `${basketballScore}/10 hoops`,
                        'Time Used': `${30 - timeLeft} seconds`,
                        'Success Rate': `${Math.round((basketballScore / 10) * 100)}%`
                    };
                    
                    showGameResult('basketball', won, stats);
                }
            }, 1000);
        }

        function resetBall() {
            const ball = document.getElementById('basketballBall');
            if (ball) {
                ball.style.left = '50px';
                ball.style.bottom = '50px';
                ball.style.transform = '';
            }
        }

        function initializeBasketballEvents() {
            const ball = document.getElementById('basketballBall');
            if (!ball) return;

            ball.addEventListener('mousedown', startDrag);
            ball.addEventListener('touchstart', startDrag);
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            startX = clientX;
            startY = clientY;
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            
            const clientX = e.clientX || e.changedTouches[0].clientX;
            const clientY = e.clientY || e.changedTouches[0].clientY;
            
            const deltaX = clientX - startX;
            const deltaY = startY - clientY;
            
            shootBall(deltaX, deltaY);
        }

        function shootBall(deltaX, deltaY) {
            const ball = document.getElementById('basketballBall');
            const basket = document.querySelector('.basket');
            
            if (!ball || !basket) return;
            
            const power = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY) / 5, 50);
            const angle = Math.atan2(deltaY, deltaX);
            
            const moveX = Math.cos(angle) * power * 8;
            const moveY = Math.sin(angle) * power * 8;
            
            ball.style.transition = 'all 1s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            ball.style.transform = `translate(${moveX}px, -${moveY}px)`;
            
            setTimeout(() => {
                const ballRect = ball.getBoundingClientRect();
                const basketRect = basket.getBoundingClientRect();
                
                const ballCenterX = ballRect.left + ballRect.width / 2;
                const ballCenterY = ballRect.top + ballRect.height / 2;
                
                if (ballCenterX >= basketRect.left && 
                    ballCenterX <= basketRect.right && 
                    ballCenterY >= basketRect.top && 
                    ballCenterY <= basketRect.bottom + 20) {
                    
                    basketballScore++;
                    document.getElementById('basketballScore').textContent = basketballScore;
                    
                    if (basketballScore >= 10) {
                        clearInterval(basketballTimer);
                    }
                }
                
                setTimeout(() => {
                    ball.style.transition = 'all 0.5s ease';
                    resetBall();
                }, 500);
                
            }, 1000);
        }

        function initializeGlobalBasketballEvents() {
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('✅ ServiceWorker registration successful');
                        // Show install prompt after service worker is ready
                        showInstallPrompt();
                    })
                    .catch(function(err) {
                        console.log('❌ ServiceWorker registration failed: ', err);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('📱 PWA install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install button if it doesn't exist
            if (!document.getElementById('installBtn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'installBtn';
                installBtn.textContent = '📱 Install App';
                installBtn.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    z-index: 1000;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;
                
                installBtn.onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to install prompt: ${outcome}`);
                        deferredPrompt = null;
                        installBtn.remove();
                    } else {
                        // Show manual instructions
                        alert(`To install this app:
                        
📱 Android Chrome: Menu (⋮) → "Add to Home screen"
🍎 iOS Safari: Share button (📤) → "Add to Home Screen"
💻 Desktop: Address bar install icon or Menu → "Install app"`);
                    }
                };
                
                document.body.appendChild(installBtn);
            }
        }

        // Event Listeners
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('registration').classList.contains('active')) {
                registerPlayer();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized!');
            
            initializeGlobalBasketballEvents();
            
            const originalStartBasketball = startBasketball;
            window.startBasketball = function() {
                originalStartBasketball();
                setTimeout(() => {
                    initializeBasketballEvents();
                }, 100);
            };
        });

        // Email download functionality
        document.getElementById('downloadEmailsBtn').onclick = function() {
            let emails = gamePlayersDB.map(p => p.email);
            try {
                const stored = JSON.parse(localStorage.getItem('gamePlayers') || '[]');
                emails = emails.concat(stored.map(p => p.email));
            } catch(e){}
            emails = [...new Set(emails)];
            const content = emails.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'registered_emails.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('isAdmin') === 'true') {
                document.getElementById('downloadEmailsBtn').style.display = 'inline-block';
            }
        });
    </script>
</body>
</html>