<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>more.com Game Suite</title>
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Game Suite">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ®</text></svg>">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="quiz-config.js" as="script">
    
    <style>
        /* CSS Custom Properties for Performance */
        :root {
            --primary-gradient: linear-gradient(135deg, #8B5DFF 0%, #00D4FF 25%, #FFE066 75%, #FF6B8A 100%);
            --primary-purple: #8B5DFF;
            --primary-cyan: #00D4FF;
            --primary-yellow: #FFE066;
            --primary-pink: #FF6B8A;
            --card-shadow: 0 20px 40px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset and Base Styles */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Performance: Use transform instead of changing layout properties */
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px;
            box-shadow: var(--card-shadow);
            max-width: 800px;
            width: 100%;
            transform: translateZ(0); /* Force GPU acceleration */
            will-change: transform; /* Optimize for animations */
        }

        /* Screen Management */
        .screen {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition);
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Registration Screen Styles */
        .more-logo {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-purple);
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .registration-title {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 32px;
            font-weight: 400;
        }

        .form-fields {
            margin-bottom: 24px;
        }

        .text-field {
            margin-bottom: 16px;
            position: relative;
        }

        .text-field input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #E5E7EB;
            border-radius: var(--border-radius);
            font-size: 16px;
            background: #FAFAFA;
            transition: var(--transition);
            outline: none;
        }

        .text-field input:focus {
            border-color: var(--primary-purple);
            background: white;
            box-shadow: 0 0 0 3px rgba(139, 93, 255, 0.1);
        }

        .text-field input::placeholder {
            color: #9CA3AF;
        }

        /* Terms Section */
        .terms-section {
            margin-bottom: 32px;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.5;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--primary-purple);
        }

        .terms-text {
            color: #6B7280;
        }

        .terms-link {
            color: var(--primary-purple);
            text-decoration: none;
            font-weight: 500;
        }

        .terms-link:hover {
            text-decoration: underline;
        }

        /* Register Button */
        .register-button {
            width: 100%;
            padding: 16px;
            background: var(--primary-purple);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            transform: translateZ(0);
        }

        .register-button:enabled:hover {
            background: #7C4EE6;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 93, 255, 0.3);
        }

        .register-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: var(--primary-purple);
            font-weight: 500;
            margin-top: 16px;
            display: none;
        }

        /* Error Display */
        .error-display {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        /* Game Selection Styles */
        .game-selection-title {
            font-size: 24px;
            font-weight: 400;
            color: #1F2937;
            text-align: center;
            margin-bottom: 8px;
        }

        .game-selection-subtitle {
            font-size: 16px;
            color: #6B7280;
            text-align: center;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .game-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-top: 24px;
        }

        .game-card {
            background: white;
            border: 2px solid #E5E7EB;
            padding: 32px 20px 24px 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            transform: translateZ(0);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-card:hover {
            border-color: var(--primary-purple);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(139, 93, 255, 0.15);
        }

        .game-icon {
            margin-bottom: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-card h3 {
            color: #1F2937;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .game-card p {
            color: #6B7280;
            font-size: 14px;
            line-height: 1.4;
            margin: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 32px 24px;
                margin: 16px;
                max-width: none;
            }
            
            body {
                padding: 16px;
            }
            
            .game-selection {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .game-card {
                padding: 24px 20px;
            }
        }

        @media (max-width: 640px) {
            .more-logo {
                font-size: 28px;
            }
            
            .game-selection-title {
                font-size: 20px;
            }
            
            .container {
                padding: 24px 20px;
            }
        }

        /* Enhanced Game Screen Styles */
        .game-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 2px solid #E5E7EB;
        }

        .back-button {
            background: transparent;
            color: #6B7280;
            border: none;
            padding: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 8px;
        }

        .back-button:hover {
            background: rgba(107, 114, 128, 0.1);
            color: #4B5563;
            transform: none; /* Remove the translateY transform */
        }

        .game-title {
            color: #1F2937;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        /* Quiz Game Enhanced Styles */
        .quiz-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .quiz-progress {
            background: #F3F4F6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 32px;
            text-align: center;
        }

        .quiz-progress .timer {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-purple);
            margin: 0;
        }

        .quiz-question {
            background: white;
            border: 2px solid #E5E7EB;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .quiz-question h3 {
            color: #1F2937;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .quiz-options {
            display: grid;
            gap: 12px;
        }

        .quiz-option {
            background: #F9FAFB;
            border: 2px solid #E5E7EB;
            padding: 16px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            font-weight: 500;
            position: relative;
        }

        .quiz-option:hover {
            border-color: var(--primary-purple);
            background: #F3F4F6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 93, 255, 0.15);
        }

        .quiz-option.selected {
            background: var(--primary-purple);
            color: white;
            border-color: var(--primary-purple);
            box-shadow: 0 4px 12px rgba(139, 93, 255, 0.3);
        }

        .quiz-actions {
            display: flex;
            justify-content: center;
            margin-top: 32px;
        }

        .quiz-button {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .quiz-button:hover {
            background: #7C4EE6;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 93, 255, 0.3);
        }

        /* Puzzle Game Enhanced Styles */
        .puzzle-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin: 32px auto;
            width: 400px;
            height: 400px;
            background: #F3F4F6;
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            contain: layout style paint;
        }

        .puzzle-tile {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: var(--transition);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transform: translateZ(0);
            will-change: transform;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .puzzle-tile:hover {
            transform: scale(1.05);
            border-color: var(--primary-purple);
            box-shadow: 0 4px 16px rgba(139, 93, 255, 0.2);
            z-index: 1;
        }

        .puzzle-tile.empty {
            background: rgba(255,255,255,0.5) !important;
            border: 2px dashed #D1D5DB;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }

        .puzzle-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 24px;
        }

        .puzzle-timer {
            background: white;
            border: 2px solid #E5E7EB;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-purple);
        }

        .reset-button {
            background: #6B7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .reset-button:hover {
            background: #4B5563;
            transform: translateY(-2px);
        }

        /* Basketball Game Enhanced Styles */
        .basketball-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .basketball-game {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #90EE90 100%);
            border-radius: 16px;
            overflow: hidden;
            contain: layout style paint;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border: 3px solid #F3F4F6;
        }

        .basketball-game::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.3) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.2) 0%, transparent 50%);
            pointer-events: none;
        }

        .basket {
            position: absolute;
            top: 120px;
            right: 60px;
            width: 100px;
            height: 50px;
            background: linear-gradient(to bottom, #D2691E, #8B4513);
            border-radius: 0 0 50px 50px;
            border: 4px solid #654321;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .basket::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 10px;
            right: 10px;
            height: 8px;
            background: #654321;
            border-radius: 4px;
        }

        .ball {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #FFA500, #FF8C00, #FF6347);
            border-radius: 50%;
            bottom: 60px;
            left: 60px;
            cursor: pointer;
            /*transition: var(--transition);*/
            border: 3px solid #FF6347;
            transform: translateZ(0);
            will-change: transform;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .ball:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(255, 140, 0, 0.4);
        }

        .ball::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 30px;
            background: #CD853F;
            transform: translate(-50%, -50%);
            border-radius: 1px;
        }

        .ball::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 2px;
            background: #CD853F;
            transform: translate(-50%, -50%);
            border-radius: 1px;
        }

        .stats {
            position: absolute;
            top: 24px;
            left: 24px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.5);
        }

        .stats div {
            margin-bottom: 8px;
            font-size: 16px;
            color: #1F2937;
        }

        .stats div:last-child {
            margin-bottom: 0;
        }

        .basketball-instructions {
            text-align: center;
            margin-top: 16px;
            padding: 16px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            font-size: 16px;
            color: #6B7280;
            font-weight: 500;
        }

        /* Game Results Enhanced Styles */
        .result-content {
            text-align: center;
            padding: 40px 20px;
        }

        .result-win {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-radius: 20px;
            padding: 48px 32px;
            margin: 20px 0;
            box-shadow: 0 16px 40px rgba(16, 185, 129, 0.3);
        }

        .result-lose {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            border-radius: 20px;
            padding: 48px 32px;
            margin: 20px 0;
            box-shadow: 0 16px 40px rgba(239, 68, 68, 0.3);
        }

        .result-title {
            font-size: 2.5em;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .result-message {
            font-size: 1.3em;
            margin-bottom: 24px;
            line-height: 1.4;
            opacity: 0.95;
        }

        .result-stats {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            font-size: 1.1em;
            backdrop-filter: blur(10px);
        }

        .result-stats div {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .result-stats div:last-child {
            margin-bottom: 0;
        }

        .result-emoji {
            font-size: 4em;
            margin-bottom: 24px;
            display: block;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .result-button {
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 160px;
        }

        .result-button:hover {
            background: #7C4EE6;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 93, 255, 0.3);
        }

        .result-button.secondary {
            background: #6B7280;
        }

        .result-button.secondary:hover {
            background: #4B5563;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Admin Button */
        .admin-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #6B7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 12px;
            cursor: pointer;
            z-index: 1000;
            display: none;
        }

        /* Install PWA Button */
        .install-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10B981;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Button -->
        <button id="downloadEmailsBtn" class="admin-button">Download Emails</button>

        <!-- Registration Screen -->
        <div id="registration" class="screen active">
            <div class="more-logo">more.com</div>
            <h2 class="registration-title">Welcome to the more.com game suite</h2>
            
            <div class="error-display" id="registrationError" role="alert"></div>
            
            <form id="registrationForm" novalidate>
                <div class="form-fields">
                    <div class="text-field">
                        <input 
                            type="text" 
                            id="name" 
                            name="name"
                            placeholder="Name" 
                            required 
                            autocomplete="given-name"
                            aria-describedby="name-error"
                        >
                    </div>
                    <div class="text-field">
                        <input 
                            type="email" 
                            id="email" 
                            name="email"
                            placeholder="Email" 
                            required 
                            autocomplete="email"
                            aria-describedby="email-error"
                        >
                    </div>
                    <div class="text-field">
                        <input 
                            type="text" 
                            id="country" 
                            name="country"
                            placeholder="Country (of residence)" 
                            required 
                            autocomplete="country"
                            aria-describedby="country-error"
                        >
                    </div>
                </div>
                
                <div class="terms-section">
                    <label class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required>
                        <span class="terms-text">
                            I accept more.com's 
                            <a href="ÎŸÎ¡ÎŸÎ™-TERMS-FIBA-GAMES-ON-COURT.pdf" class="terms-link" target="_blank" rel="noopener">Terms of use.</a>
                        </span>
                    </label>
                </div>
                
                <button type="submit" id="registerBtn" class="register-button" disabled>
                    Start
                </button>
                
                <div class="loading" id="loadingMessage">Registering player...</div>
            </form>
        </div>

        <!-- Game Selection Screen -->
        <div id="gameSelection" class="screen">
            <div class="more-logo">more.com</div>
            <h1 class="game-selection-title">Hi, <span id="playerName" style="font-weight: 700;"></span></h1>
            <p class="game-selection-subtitle">Choose 1 game</p>
            
            <div class="game-selection">
                <div class="game-card" onclick="GameManager.startQuiz()">
                    <div class="game-icon">
                        <img src="quiz-icon.png" alt="Quiz Icon" width="60" height="60">
                    </div>
                    <h3>Quiz challenge</h3>
                    <p>Answer all 5 questions correctly</p>
                </div>
                
                <div class="game-card" onclick="GameManager.startPuzzle()">
                    <div class="game-icon">
                        <img src="puzzle-icon.png" alt="Puzzle Icon" width="60" height="60">
                    </div>
                    <h3>FIBA Puzzle master</h3>
                    <p>Solve the sliding puzzle in time</p>
                </div>
                
                <div class="game-card" onclick="GameManager.startBasketball()">
                    <div class="game-icon">
                        <img src="ball-icon.png" alt="Ball Icon" width="60" height="60">
                    </div>
                    <h3>More Hoops</h3>
                    <p>Score 5 hoops within the time limit</p>
                </div>
            </div>
        </div>

        <!-- Quiz Game Screen -->
        <div id="quizGame" class="screen">
            <div class="game-header">
                <button class="back-button" onclick="UIManager.backToSelection()"><img src="back-icon.png" alt="back icon"/></button>
                <h2 class="game-title">Quiz Challenge</h2>
            </div>
            
            <div class="quiz-container">
                <div class="quiz-progress">
                    <div class="timer" id="quizTimer">Question 1 of 5</div>
                </div>
                
                <div id="quizContent"></div>
                
                <div class="quiz-actions">
                    <button id="nextQuestion" onclick="QuizGame.nextQuestion()" class="quiz-button hidden">Next Question</button>
                    <button id="finishQuiz" onclick="QuizGame.finishQuiz()" class="quiz-button hidden">Finish Quiz</button>
                </div>
            </div>
        </div>

        <!-- Puzzle Game Screen -->
        <div id="puzzleGame" class="screen">
            <div class="game-header">
                <button class="back-button" onclick="UIManager.backToSelection()"><img src="back-icon.png" alt="back icon"/></button>
                <h2 class="game-title">Sliding Puzzle</h2>
            </div>
            
            <div class="puzzle-container" id="puzzleContainer"></div>
            
            <div class="puzzle-controls">
                <div class="puzzle-timer" id="puzzleTimer">Time: 40s</div>
                <button onclick="PuzzleGame.reset()" class="reset-button">Reset</button>
            </div>
        </div>

        <!-- Basketball Game Screen -->
        <div id="basketballGame" class="screen">
            <div class="game-header">
                <button class="back-button" onclick="UIManager.backToSelection()"><img src="back-icon.png" alt="back icon"/></button>
                <h2 class="game-title">Basketball Hoops</h2>
            </div>
            
            <div class="basketball-container">
                <div class="basketball-game">
                    <div class="stats">
                        <div>Score: <span id="basketballScore">0</span>/5</div>
                        <div>Time: <span id="basketballTimer">30</span>s</div>
                    </div>
                    <div class="basket"></div>
                    <div class="ball" id="basketballBall"></div>
                </div>
                
                <div class="basketball-instructions">
                    Click and drag the ball towards the basket!
                </div>
            </div>
        </div>

        <!-- Game Results Screen -->
        <div id="gameResults" class="screen">
            <div id="resultContent" class="result-content"></div>
            <div class="result-actions">
                <button onclick="UIManager.backToSelection()" class="result-button">
                    Play Another Game
                </button>
                <button onclick="UIManager.showScreen('registration')" class="result-button secondary">
                    New Player
                </button>
            </div>
        </div>
    </div>

    <!-- Performance: Load scripts after DOM -->
    <script src="quiz-config.js" defer></script>
    <script>
        // Performance-Optimized Game Architecture
        class PerformanceOptimizer {
            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }

            static fastRAF(callback) {
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(callback);
                } else {
                    requestAnimationFrame(callback);
                }
            }

            static preloadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            }
        }

        // Centralized State Management
        class GameState {
            constructor() {
                this.currentPlayer = null;
                this.gameData = {
                    quiz: { currentQuestion: 0, score: 0, selectedAnswer: null },
                    puzzle: { grid: [], timeLeft: 90, timer: null },
                    basketball: { score: 0, timer: null, isDragging: false }
                };
                this.playersDB = [];
            }

            updateGameData(game, data) {
                this.gameData[game] = { ...this.gameData[game], ...data };
            }

            savePlayer(playerData) {
                playerData.id = Date.now();
                playerData.timestamp = new Date().toISOString();
                playerData.games = [];
                
                this.playersDB.push(playerData);
                this.currentPlayer = playerData;
                console.log('Player saved:', playerData);
                return playerData;
            }

            updatePlayerGameResult(playerId, gameType, result) {
                const player = this.playersDB.find(p => p.id === playerId);
                if (player) {
                    player.games.push({
                        type: gameType,
                        result: result,
                        timestamp: new Date().toISOString()
                    });
                }
            }
        }

        // UI Management
        class UIManager {
            static showScreen(screenId) {
                // Performance: Batch DOM operations
                const screens = document.querySelectorAll('.screen');
                const targetScreen = document.getElementById(screenId);
                
                if (!targetScreen) {
                    console.error('Screen not found:', screenId);
                    return false;
                }

                // Use requestAnimationFrame for smooth transitions
                requestAnimationFrame(() => {
                    screens.forEach(screen => {
                        screen.classList.remove('active');
                    });
                    
                    requestAnimationFrame(() => {
                        targetScreen.classList.add('active');
                    });
                });

                return true;
            }

            static showError(message) {
                const errorDiv = document.getElementById('registrationError');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 4000);
                }
            }

            static showLoading(show = true) {
                const loadingDiv = document.getElementById('loadingMessage');
                const button = document.getElementById('registerBtn');
                
                if (loadingDiv && button) {
                    loadingDiv.style.display = show ? 'block' : 'none';
                    button.disabled = show;
                    button.style.opacity = show ? '0.5' : '1';
                }
            }

            static backToSelection() {
                UIManager.showScreen('gameSelection');
                // Clean up any running timers
                if (gameState.gameData.puzzle.timer) {
                    clearInterval(gameState.gameData.puzzle.timer);
                }
                if (gameState.gameData.basketball.timer) {
                    clearInterval(gameState.gameData.basketball.timer);
                }
            }

            static showGameResult(gameType, won, stats = {}) {
                const resultContent = document.getElementById('resultContent');
                if (!resultContent) return;

                const resultData = {
                    win: {
                        message: "Congrats on winning a More.com Present",
                        class: "result-win",
                        emoji: "ðŸŽ‰",
                        title: "WINNER!"
                    },
                    lose: {
                        message: "Well.. that was unlucky wasn't it?",
                        class: "result-lose", 
                        emoji: "ðŸ˜…",
                        title: "GAME OVER"
                    }
                };

                const result = won ? resultData.win : resultData.lose;
                
                let statsHtml = '';
                if (Object.keys(stats).length > 0) {
                    statsHtml = '<div class="result-stats">';
                    for (const [key, value] of Object.entries(stats)) {
                        statsHtml += `<div><strong>${key}:</strong> ${value}</div>`;
                    }
                    statsHtml += '</div>';
                }

                resultContent.innerHTML = `
                    <div class="${result.class}">
                        <span class="result-emoji">${result.emoji}</span>
                        <div class="result-title">${result.title}</div>
                        <div class="result-message">${result.message}</div>
                        ${statsHtml}
                    </div>
                `;

                UIManager.showScreen('gameResults');
                
                if (gameState.currentPlayer) {
                    gameState.updatePlayerGameResult(gameState.currentPlayer.id, gameType, {
                        won: won,
                        stats: stats,
                        timestamp: new Date().toISOString()
                    });
                }
            }
        }

        // Registration Management
        class RegistrationManager {
            constructor() {
                this.form = document.getElementById('registrationForm');
                this.submitButton = document.getElementById('registerBtn');
                this.initializeValidation();
            }

            initializeValidation() {
                const inputs = this.form.querySelectorAll('input[required]');
                const termsCheckbox = document.getElementById('termsCheckbox');
                
                // Ensure button starts disabled
                this.submitButton.disabled = true;
                this.submitButton.style.opacity = '0.5';
                this.submitButton.style.cursor = 'not-allowed';
                
                // Debounced validation for performance
                const debouncedValidation = PerformanceOptimizer.debounce(() => {
                    this.validateForm();
                }, 100);

                inputs.forEach(input => {
                    input.addEventListener('input', debouncedValidation);
                    input.addEventListener('blur', debouncedValidation);
                });

                termsCheckbox.addEventListener('change', debouncedValidation);
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                
                // Run initial validation
                this.validateForm();
            }

            validateForm() {
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const country = document.getElementById('country').value.trim();
                const termsAccepted = document.getElementById('termsCheckbox').checked;

                if (name.toLowerCase() === 'admin') {
                    document.getElementById('downloadEmailsBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('downloadEmailsBtn').style.display = 'none';
                }

                const isValid = name && email && country && termsAccepted && this.isValidEmail(email);
                
                // Performance: Only update if state changed
                const currentState = !this.submitButton.disabled;
                if (currentState !== isValid) {
                    this.submitButton.disabled = !isValid;
                    
                    // Visual feedback for button state
                    if (isValid) {
                        this.submitButton.style.opacity = '1';
                        this.submitButton.style.cursor = 'pointer';
                    } else {
                        this.submitButton.style.opacity = '0.5';
                        this.submitButton.style.cursor = 'not-allowed';
                    }
                }
            }

            isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(this.form);
                const playerData = {
                    name: formData.get('name').trim(),
                    email: formData.get('email').trim(),
                    country: formData.get('country').trim()
                };

                if (!this.isValidEmail(playerData.email)) {
                    UIManager.showError('Please enter a valid email address.');
                    return;
                }

                UIManager.showLoading(true);

                // Simulate API call with realistic delay
                try {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    const player = gameState.savePlayer(playerData);
                    
                    const playerNameElement = document.getElementById('playerName');
                    if (playerNameElement) {
                        playerNameElement.textContent = player.name;
                    }

                    UIManager.showLoading(false);
                    UIManager.showScreen('gameSelection');
                    
                } catch (error) {
                    console.error('Registration error:', error);
                    UIManager.showLoading(false);
                    UIManager.showError('Registration failed. Please try again.');
                }
            }
        }

        // Game Managers
        class QuizGame {
            static async start() {
                gameState.updateGameData('quiz', { currentQuestion: 0, score: 0 });
                UIManager.showScreen('quizGame');
                await QuizGame.displayQuestion();
            }

            static async displayQuestion() {
                const quizData = gameState.gameData.quiz;
                const question = window.QUIZ_CONFIG.questions[quizData.currentQuestion];
                
                gameState.updateGameData('quiz', { selectedAnswer: null });
                
                document.getElementById('quizTimer').textContent = 
                    `Question ${quizData.currentQuestion + 1} of ${window.QUIZ_CONFIG.questions.length}`;
                
                const content = document.getElementById('quizContent');
                content.innerHTML = `
                    <div class="quiz-question">
                        <h3>${question.question}</h3>
                        <div class="quiz-options">
                            ${question.options.map((option, index) => 
                                `<div class="quiz-option" onclick="QuizGame.selectAnswer(${index})">${option}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('nextQuestion').classList.add('hidden');
                document.getElementById('finishQuiz').classList.add('hidden');
            }

            static selectAnswer(answerIndex) {
                gameState.updateGameData('quiz', { selectedAnswer: answerIndex });
                
                // Performance: Batch DOM updates
                requestAnimationFrame(() => {
                    document.querySelectorAll('.quiz-option').forEach((option, index) => {
                        option.classList.remove('selected');
                        if (index === answerIndex) {
                            option.classList.add('selected');
                        }
                    });
                    
                    const quizData = gameState.gameData.quiz;
                    const isLastQuestion = quizData.currentQuestion >= window.QUIZ_CONFIG.questions.length - 1;
                    
                    if (isLastQuestion) {
                        document.getElementById('finishQuiz').classList.remove('hidden');
                    } else {
                        document.getElementById('nextQuestion').classList.remove('hidden');
                    }
                });
            }

            static nextQuestion() {
                const quizData = gameState.gameData.quiz;
                if (quizData.selectedAnswer !== null) {
                    if (quizData.selectedAnswer === window.QUIZ_CONFIG.questions[quizData.currentQuestion].correct) {
                        gameState.updateGameData('quiz', { score: quizData.score + 1 });
                    }
                    gameState.updateGameData('quiz', { currentQuestion: quizData.currentQuestion + 1 });
                    QuizGame.displayQuestion();
                }
            }

            static finishQuiz() {
                const quizData = gameState.gameData.quiz;
                if (quizData.selectedAnswer !== null) {
                    let finalScore = quizData.score;
                    if (quizData.selectedAnswer === window.QUIZ_CONFIG.questions[quizData.currentQuestion].correct) {
                        finalScore++;
                    }
                    
                    const passed = finalScore === 5;
                    const stats = {
                        'Score': `${finalScore}/${window.QUIZ_CONFIG.questions.length}`,
                        'Percentage': `${Math.round((finalScore / window.QUIZ_CONFIG.questions.length) * 100)}%`
                    };
                    
                    UIManager.showGameResult('quiz', passed, stats);
                }
            }
        }

        class PuzzleGame {
            static async start() {
                UIManager.showScreen('puzzleGame');
                await PuzzleGame.loadImages();
                PuzzleGame.initialize();
                // Don't start timer here - wait until after shuffle
            }

            static async loadImages() {
                console.log('Loading puzzle images...');
                const imagePromises = [];
                
                for (let i = 1; i <= 8; i++) {
                    imagePromises.push(
                        PerformanceOptimizer.preloadImage(`images/${i}.jpg`)
                            .catch(() => PuzzleGame.createFallbackImage(i))
                    );
                }
                
                try {
                    const images = await Promise.all(imagePromises);
                    gameState.updateGameData('puzzle', { images });
                    console.log('Puzzle images loaded successfully');
                } catch (error) {
                    console.error('Error loading puzzle images:', error);
                    PuzzleGame.createFallbackImages();
                }
            }

            static createFallbackImage(number) {
                const svg = `
                    <svg width="95" height="95" xmlns="http://www.w3.org/2000/svg">
                        <rect width="95" height="95" fill="#8B5DFF" rx="4"/>
                        <text x="47.5" y="52" text-anchor="middle" fill="white" font-size="24" font-weight="bold">${number}</text>
                    </svg>
                `;
                return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
            }

            static createFallbackImages() {
                const images = [];
                for (let i = 1; i <= 8; i++) {
                    images.push(PuzzleGame.createFallbackImage(i));
                }
                gameState.updateGameData('puzzle', { images });
            }

            static initialize() {
                const grid = Array.from({length: 8}, (_, i) => i + 1);
                grid.push(null);
                
                gameState.updateGameData('puzzle', { grid, timeLeft: 40 });
                PuzzleGame.render();
                
                // Show solved puzzle for 3 seconds, THEN start timer after shuffle
                setTimeout(() => {
                    PuzzleGame.shuffle();
                    PuzzleGame.render();
                    // Start timer only after puzzle is shuffled and playable
                    PuzzleGame.startTimer();
                }, 3000);
            }

            static render() {
                const container = document.getElementById('puzzleContainer');
                const puzzleData = gameState.gameData.puzzle;
                
                // Performance: Use DocumentFragment
                const fragment = document.createDocumentFragment();
                
                puzzleData.grid.forEach((tileNumber, position) => {
                    const tileElement = document.createElement('div');
                    tileElement.className = 'puzzle-tile';
                    
                    if (tileNumber === null) {
                        tileElement.classList.add('empty');
                        tileElement.style.background = 'rgba(255,255,255,0.3)';
                    } else {
                        const image = puzzleData.images[tileNumber - 1];
                        if (typeof image === 'string') {
                            tileElement.style.backgroundImage = `url("${image}")`;
                        } else {
                            tileElement.style.backgroundImage = `url("${image.src}")`;
                        }
                        
                        tileElement.addEventListener('click', () => PuzzleGame.moveTile(position), { passive: true });
                    }
                    
                    fragment.appendChild(tileElement);
                });
                
                container.innerHTML = '';
                container.appendChild(fragment);
            }

            static moveTile(clickedPosition) {
                const puzzleData = gameState.gameData.puzzle;
                const emptyPosition = puzzleData.grid.indexOf(null);
                
                if (PuzzleGame.isAdjacent(clickedPosition, emptyPosition)) {
                    const newGrid = [...puzzleData.grid];
                    [newGrid[clickedPosition], newGrid[emptyPosition]] = [newGrid[emptyPosition], newGrid[clickedPosition]];
                    
                    gameState.updateGameData('puzzle', { grid: newGrid });
                    PuzzleGame.render();
                    
                    if (PuzzleGame.isSolved()) {
                        clearInterval(puzzleData.timer);
                        const timeUsed = 40 - puzzleData.timeLeft;
                        UIManager.showGameResult('puzzle', true, {
                            'Time Used': `${timeUsed} seconds`,
                            'Time Remaining': `${puzzleData.timeLeft} seconds`
                        });
                    }
                }
            }

            static isAdjacent(pos1, pos2) {
                const row1 = Math.floor(pos1 / 3);
                const col1 = pos1 % 3;
                const row2 = Math.floor(pos2 / 3);
                const col2 = pos2 % 3;
                
                return (Math.abs(row1 - row2) === 1 && col1 === col2) || 
                       (Math.abs(col1 - col2) === 1 && row1 === row2);
            }

            static isSolved() {
                const grid = gameState.gameData.puzzle.grid;
                for (let i = 0; i < grid.length - 1; i++) {
                    if (grid[i] !== i + 1) return false;
                }
                return grid[grid.length - 1] === null;
            }

            static shuffle() {
                const puzzleData = gameState.gameData.puzzle;
                let grid = [...puzzleData.grid];
                
                for (let i = 0; i < 1000; i++) {
                    const emptyPos = grid.indexOf(null);
                    const adjacent = PuzzleGame.getAdjacentPositions(emptyPos);
                    const randomPos = adjacent[Math.floor(Math.random() * adjacent.length)];
                    [grid[emptyPos], grid[randomPos]] = [grid[randomPos], grid[emptyPos]];
                }
                
                gameState.updateGameData('puzzle', { grid });
            }

            static getAdjacentPositions(position) {
                const row = Math.floor(position / 3);
                const col = position % 3;
                const adjacent = [];
                
                if (row > 0) adjacent.push((row - 1) * 3 + col);
                if (row < 2) adjacent.push((row + 1) * 3 + col);
                if (col > 0) adjacent.push(row * 3 + (col - 1));
                if (col < 2) adjacent.push(row * 3 + (col + 1));
                
                return adjacent;
            }

            static startTimer() {
                const timer = setInterval(() => {
                    // Get fresh reference to current puzzle data each time
                    const currentPuzzleData = gameState.gameData.puzzle;
                    const newTimeLeft = currentPuzzleData.timeLeft - 1;
                    
                    gameState.updateGameData('puzzle', { timeLeft: newTimeLeft });
                    document.getElementById('puzzleTimer').textContent = `Time: ${newTimeLeft}s`;
                    
                    if (newTimeLeft <= 0) {
                        clearInterval(timer);
                        UIManager.showGameResult('puzzle', false, {
                            'Result': 'Time expired',
                            'Time Limit': '40 seconds'
                        });
                    }
                }, 1000);
                
                gameState.updateGameData('puzzle', { timer });
            }

            static reset() {
                const puzzleData = gameState.gameData.puzzle;
                if (puzzleData.timer) {
                    clearInterval(puzzleData.timer);
                }
                PuzzleGame.initialize();
                PuzzleGame.startTimer();
                document.getElementById('puzzleTimer').textContent = `Time: 40s`;
            }
        }

class BasketballGame {
    static start() {
        UIManager.showScreen('basketballGame');
        gameState.updateGameData('basketball', { 
            score: 0, 
            isDragging: false,
            animationFrame: null,
            ballPosition: { x: 60, y: 60 }
        });
        document.getElementById('basketballScore').textContent = '0';
        BasketballGame.resetBall();
        BasketballGame.startTimer();
        BasketballGame.initializeEvents();
    }

    static initializeEvents() {
        const ball = document.getElementById('basketballBall');
        if (!ball) return;

        ball.addEventListener('mousedown', BasketballGame.startDrag, { passive: false });
        ball.addEventListener('touchstart', BasketballGame.startDrag, { passive: false });
        
        document.addEventListener('mousemove', BasketballGame.drag, { passive: true });
        document.addEventListener('touchmove', BasketballGame.drag, { passive: true });
        
        document.addEventListener('mouseup', BasketballGame.endDrag, { passive: true });
        document.addEventListener('touchend', BasketballGame.endDrag, { passive: true });
    }

    static startDrag(e) {
        e.preventDefault();
        const basketballData = gameState.gameData.basketball;
        
        // Only allow dragging if ball is at starting position
        if (basketballData.animationFrame) return;
        
        gameState.updateGameData('basketball', { 
            isDragging: true,
            startX: e.clientX || e.touches[0].clientX,
            startY: e.clientY || e.touches[0].clientY,
            startTime: Date.now()
        });
    }

    static drag(e) {
        const basketballData = gameState.gameData.basketball;
        if (!basketballData.isDragging) return;
        
        const currentX = e.clientX || e.touches[0].clientX;
        const currentY = e.clientY || e.touches[0].clientY;
        
        // Show trajectory preview (optional visual feedback)
        const deltaX = currentX - basketballData.startX;
        const deltaY = basketballData.startY - currentY;
        
        // Small visual feedback during drag
        const ball = document.getElementById('basketballBall');
        if (ball && Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
            ball.style.transform = `scale(${Math.min(1.2, 1 + Math.sqrt(deltaX*deltaX + deltaY*deltaY)/200)})`;
        }
    }

    static endDrag(e) {
        const basketballData = gameState.gameData.basketball;
        if (!basketballData.isDragging) return;
        
        gameState.updateGameData('basketball', { isDragging: false });
        
        const clientX = e.clientX || e.changedTouches[0].clientX;
        const clientY = e.clientY || e.changedTouches[0].clientY;
        
        const deltaX = clientX - basketballData.startX;
        const deltaY = basketballData.startY - clientY;
        
        // More sensitive velocity calculation for better trajectory
        const velocityX = deltaX * 4; // Horizontal velocity
        const velocityY = deltaY * 10; // More sensitive upward motion
        
        BasketballGame.shootBall(velocityX, velocityY);
    }

    static shootBall(velocityX, velocityY) {
        const ball = document.getElementById('basketballBall');
        const gameContainer = document.querySelector('.basketball-game');
        if (!ball || !gameContainer) return;
        
        // Reset ball scale
        ball.style.transform = 'scale(1)';
        
        // Physics constants - much gentler gravity
        let gravity = 0.8; // Much weaker gravity for higher arc
        const startX = 60;
        const startY = 60;
        
        console.log(`velocityY: ${velocityY}`)
        console.log(`velocityX: ${velocityX}`)
        console.log(`**********************`)
        


        let currentX = startX;
        let currentY = startY;
        let currentVelocityX = velocityX / 60; // Horizontal speed - NEVER changes
        let currentVelocityY = velocityY / 80; // Vertical speed - affected by gravity
        
        const containerRect = gameContainer.getBoundingClientRect();
        const ballSize = 40;
        
        let hasScored = false;
        let ballPassed = false;
        
        function animate() {
            // IMPORTANT: Only apply gravity to Y velocity, X velocity stays constant
            
            currentVelocityY -= gravity; // Full gravity effect while going down
            currentVelocityX -= 0.005; // Slight horizontal deceleration to simulate air resistance

            console.log(`currentVelocityY: ${currentVelocityY}`)
            console.log(`currentVelocityX: ${currentVelocityX}`)

            currentX += currentVelocityX; // Constant horizontal speed
            currentY += currentVelocityY; // Changing vertical speed due to gravity
            
            // Update ball position (allow it to go outside horizontal bounds)
            ball.style.left = `${currentX}px`;
            ball.style.bottom = `${currentY}px`;

            console.log(`X: ${currentX}px`)
            console.log(`Y: ${currentY}px`)

            // Check for scoring only when ball is within scoring area
            if (!hasScored && currentX > 485 && currentX < 545) {
                if (currentVelocityY < 0 && currentY > 320 && currentY < 380) {
                    hasScored = true;
                    BasketballGame.scoreBasket();
                }
            }
            
            // Only stop animation when ball hits the ground (y <= 0)
            if (currentY > 0) {
                const animationFrame = requestAnimationFrame(animate);
                gameState.updateGameData('basketball', { animationFrame });
            } else {
                // Ball has hit the ground, reset after brief delay
                BasketballGame.resetBallAfterShot();
            }
        }
        
        const animationFrame = requestAnimationFrame(animate);
        gameState.updateGameData('basketball', { animationFrame });
    }

    static scoreBasket() {
        const newScore = gameState.gameData.basketball.score + 1;
        gameState.updateGameData('basketball', { score: newScore });
        document.getElementById('basketballScore').textContent = newScore;
        
        // Visual feedback for scoring
        const ball = document.getElementById('basketballBall');
        if (ball) {
            ball.style.filter = 'drop-shadow(0 0 10px #00ff00)';
            setTimeout(() => {
                if (ball) ball.style.filter = '';
            }, 200);
        }
        
        if (newScore >= 5) {
            clearInterval(gameState.gameData.basketball.timer);
        }
    }

    static resetBallAfterShot() {
        // Cancel any ongoing animation
        if (gameState.gameData.basketball.animationFrame) {
            cancelAnimationFrame(gameState.gameData.basketball.animationFrame);
        }
        
        setTimeout(() => {
            BasketballGame.resetBall();
        }, 500);
    }

    static resetBall() {
        const ball = document.getElementById('basketballBall');
        if (ball) {
            ball.style.left = '60px';
            ball.style.bottom = '60px';
            ball.style.transform = 'scale(1)';
            ball.style.filter = '';
        }
        
        gameState.updateGameData('basketball', { 
            animationFrame: null,
            ballPosition: { x: 60, y: 60 }
        });
    }

    static startTimer() {
        let timeLeft = 30;
        document.getElementById('basketballTimer').textContent = timeLeft;
        
        const timer = setInterval(() => {
            timeLeft--;
            document.getElementById('basketballTimer').textContent = timeLeft;
            
            if (timeLeft <= 0 || gameState.gameData.basketball.score >= 5) {
                clearInterval(timer);
                
                // Cancel any ongoing ball animation
                if (gameState.gameData.basketball.animationFrame) {
                    cancelAnimationFrame(gameState.gameData.basketball.animationFrame);
                }
                
                const won = gameState.gameData.basketball.score >= 5;
                const stats = {
                    'Final Score': `${gameState.gameData.basketball.score}/5 hoops`,
                    'Time Used': `${30 - timeLeft} seconds`,
                    'Success Rate': `${Math.round((gameState.gameData.basketball.score / 5) * 100)}%`
                };
                
                UIManager.showGameResult('basketball', won, stats);
            }
        }, 1000);
        
        gameState.updateGameData('basketball', { timer });
    }
}        


        // Game Manager - Central coordinator
        class GameManager {
            static startQuiz() {
                QuizGame.start();
            }

            static startPuzzle() {
                PuzzleGame.start();
            }

            static startBasketball() {
                BasketballGame.start();
            }
        }

        // PWA Management
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.initializeServiceWorker();
                this.initializeInstallPrompt();
            }

            async initializeServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('sw.js');
                        console.log('ServiceWorker registered successfully');
                    } catch (error) {
                        console.log('ServiceWorker registration failed:', error);
                    }
                }
            }

            initializeInstallPrompt() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });
            }

            showInstallButton() {
                if (document.getElementById('installBtn')) return;
                
                const installBtn = document.createElement('button');
                installBtn.id = 'installBtn';
                installBtn.className = 'install-button';
                installBtn.textContent = 'ðŸ“± Add more.games';
                
                installBtn.onclick = async () => {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        const { outcome } = await this.deferredPrompt.userChoice;
                        console.log(`Install prompt outcome: ${outcome}`);
                        this.deferredPrompt = null;
                        installBtn.remove();
                    }
                };
                
                document.body.appendChild(installBtn);
            }
        }

        // Email Download for Admin
        class AdminManager {
            constructor() {
                this.initializeEmailDownload();
                this.checkAdminAccess();
            }

            initializeEmailDownload() {
                document.getElementById('downloadEmailsBtn').onclick = () => {
                    const emails = [...new Set(gameState.playersDB.map(p => p.email))];
                    const content = emails.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'registered_emails.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
            }

            checkAdminAccess() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('isAdmin') === 'true' || urlParams.get('IsAdmin') === 'true' || urlParams.get('admin') === 'true') {
                    document.getElementById('downloadEmailsBtn').style.display = 'inline-block';
                }
            }
        }

        // Initialize Application
        const gameState = new GameState();
        let registrationManager;
        let pwaManager;
        let adminManager;

        // Performance: Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸŽ® Game Suite Initialized');
            
            // Initialize managers
            registrationManager = new RegistrationManager();
            pwaManager = new PWAManager();
            adminManager = new AdminManager();
            
            // Make GameManager globally accessible for onclick handlers
            window.GameManager = GameManager;
            window.UIManager = UIManager;
            window.QuizGame = QuizGame;
            window.PuzzleGame = PuzzleGame;
            window.BasketballGame = BasketballGame;
            
            console.log('âœ… All systems ready');
        });

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Application error:', e.error);
            // Could send to error tracking service here
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log(`Page load performance: ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`);
            }
        });
    </script>
</body>
</html>